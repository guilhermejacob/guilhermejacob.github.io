---
title: 'Out of school children in Brazil: an exercise on data visualization'
author: ~
date: '2017-05-17'
slug: out-of-school-children-in-brazil-an-exercise-on-data-visualization
categories: ["R" , "Complex Survey" , "Official Statistics" ]
tags: [ "Children's Rights" , "Rstats" , "DataViz" , "Brazil" , "Education" ]
draft: false
output: 
  html_document: 
    keep_md: yes
    # self_contained: yes
---

# PNAD and the importance of household surveys

The most common source for Brazilian information about living standards is the PNAD^[The *Pesquisa Nacional por Amostra de Domic√≠lios* (PNAD) is a survey of Brazilian households, conducted every year.]. Usually, when some institution says something about poverty, inequality, education, housing, etc. in Brazil, they recur to the amazing publications produced by the Brazilian Institute for Geography and Statistics (IBGE).

But that is how it's *usually* done. IBGE also produces amazing microdata, available to everyone. Using it, researchers can focus on specific questions regarding any topic investigated in the survey. The R workflow for the analysis of those sets is presented <a href="http://www.asdfree.com" target="_blank">here</a> at length, even showing how to match official statistics. This post aims to show how to visualize some results produced using that framework.

Yet, it is **extremely important to calculate the variance**. This step is commonly overlooked by many practitioners and researchers. And, while some don't even try, others try to calculate it, but fail to use the adequate sample design. In this post, our challenge is to present why it is important to calculate the variance and how it can be used in a practical approach.

# The right to education: an evidence-based analysis

Let's analyse a set of results produced in R using data from 2005 to 2015. The plot below shows some convergence across the regions. This is somewhat expected if you consider that increasing school access becomes harder the closer we get to 100% inclusion.

```{r overall.plot, echo=FALSE, message=FALSE, warning=FALSE}
results <- readRDS( "/home/guilherme/GitLab/src-website/static/datasets/2005-2015 OutOfSchool.rds" )

library(plyr)

# collect and create data frames

# overall
overall <- 
  plyr::ldply( results , .fun = function(x) {
    
    year <- x[[1]]
    this_year <- x[["overall"]]
    
    ab_compiled <- plyr::ldply( this_year , .fun = function(y) {
      
      pct.br.data <- y[["percentual"]][["brasil"]]
      names(pct.br.data) <- c( "area", "pct_Freq" , "ci_l" , "ci_u" )
      pct.br.data[[1]] <- "Brasil"
      abs.br.data <- y[["absoluto"]][["brasil"]]
      names(abs.br.data) <- c( "area", "abs_Freq" , "abs_NFreq" , "SE_abs_Freq" , "SE_abs_NFreq" )
      abs.br.data[[1]] <- "Brasil"
      
      br.data <- cbind( abs.br.data , pct.br.data [,-1])
      
      pct.rg.data <- y[["percentual"]][["regiao"]]
      names(pct.rg.data) <- c( "area", "pct_Freq" , "ci_l" , "ci_u" )
      abs.rg.data <- y[["absoluto"]][["regiao"]]
      names(abs.rg.data) <- c( "area", "abs_Freq" , "abs_NFreq" , "SE_abs_Freq" , "SE_abs_NFreq" )
      
      rg.data <- cbind( abs.rg.data , pct.rg.data [,-1])
      
      rbind( br.data , rg.data )
      
    } )
    colnames( ab_compiled )[1] <- "agebreak"
    cbind( year , ab_compiled )
    
  } )

# by income class
income <- 
  plyr::ldply( results , .fun = function(x) {
    
    year <- x[[1]]
    this_year <- x[["inc.cls"]]
    
    ab_compiled <- plyr::ldply( this_year , .fun = function(y) {
      
      pct.br.data <- y[["percentual"]][["brasil"]]
      names(pct.br.data) <- c( "area", "raca" , "pct_Freq" , "ci_l" , "ci_u" )
      pct.br.data[[1]] <- "Brasil"
      abs.br.data <- y[["absoluto"]][["brasil"]]
      names(abs.br.data) <- c( "area", "raca" , "abs_Freq" , "abs_NFreq" , "SE_abs_Freq" , "SE_abs_NFreq" )
      abs.br.data[[1]] <- "Brasil"
      
      br.data <- cbind( abs.br.data , pct.br.data [,-1])
      
      pct.rg.data <- y[["percentual"]][["regiao"]]
      names(pct.rg.data) <- c( "area", "raca" , "pct_Freq" , "ci_l" , "ci_u" )
      abs.rg.data <- y[["absoluto"]][["regiao"]]
      names(abs.rg.data) <- c( "area", "raca" , "abs_Freq" , "abs_NFreq" , "SE_abs_Freq" , "SE_abs_NFreq" )
      
      rg.data <- cbind( abs.rg.data , pct.rg.data [,-1])
      
      rbind( br.data , rg.data )
      
    } )
    
    colnames( ab_compiled )[1] <- "agebreak"
    cbind( year , ab_compiled )
    
    
  } )

# remove unnecessary result object
rm( results )

# collect result
final_list <- list( overall = overall , income = income )
rm( list = names(final_list) )

# recode age breaks
final_list <- llply( final_list , function(x) {
  x$agebreak <- factor( x$agebreak , 
                        levels = c("ab12_14", "ab15_17", "ab4_17", "ab4_5", "ab6_11", "ab6_14") , 
                        labels = c("12 to 14 years old" ,  "15 to 17 years old" , "4 to 17 years old" , "4 and 5 years old" , "6 to 11 years old" , "6 to 14 years old" ) )
  return(x)
  
} )

# recode age regions
final_list <- llply( final_list , function(x) {
  x$area <- factor( x$area , 
                    levels = c("Brasil", "Norte", "Nordeste", "Sudeste", "Sul", "Centro-Oeste") ,
                    labels = c("Brazil", "North", "Northeast", "Southeast", "South", "Center-west") )
  return(x)
  
} )

# turn dataframes into tbl_df
library(dplyr)
final_list <- llply( final_list , function(x) { tbl_df(x) } )

# plotting
library(ggplot2)
library(gridExtra)
library(grid)
library(scales)
library(ggiraph)

oa.rg <- ggplot( final_list$overall %>%
                   mutate( tooltip = paste0('<table><th>', round(100*pct_Freq , 1),'%</th></table><tr><td>', area,'\n', year,'</td></tr>') ) %>%
                   filter( agebreak == "4 to 17 years old" ) , aes(year, pct_Freq , group = area , color = area , tooltip = tooltip , onclick = "opacity=.3;" ) ) +
  geom_line( alpha = .3 ) + 
  #geom_errorbar(aes(ymin=ci_l, ymax=ci_u), width=.1 , alpha = .5 ) +
  geom_point_interactive( size = 1) +
  scale_y_continuous( labels = percent , expand = c(0,0) ) +
  scale_x_continuous( breaks = 2005:2015, labels = 2005:2015 ) +
  coord_cartesian(ylim=c(.7 , 1) , xlim = c(2005,2015) ) +
  labs( x = "Years" , y = "Percentage", 
        title = "Children and adolescents going to school" , 
        subtitle ="By region" , 
        caption = "Source: PNAD 2005-2015. Microdata.") +
  scale_color_brewer(type = "qual" , palette = "Dark2" , direction = 1 ) +
  guides(color = guide_legend(title = "Region", title.position = "top") ) +
  theme_dark() +
  theme( panel.grid.minor.x = element_blank() , plot.title = element_text(lineheight=.8, face="bold") ) 

ggiraph( code = {print(oa.rg)} , zoom_max = 5 , width = 1 , tooltip_opacity = .7 , width_svg = 8, height_svg= 4 )
```

Well, that is a good start. A careless analyst might say:

> In 2015, the school attendance rate in the South was higher than in the Center-west region.

**Is it really?**

![How I picture myself everytime this happens.](../../../img/0d4f72c579c2ab56d58d6f67b138aac1.jpg)

As you ~~should have~~ learned in your Statistics lectures, this is not how you're supposed to do it. since this information comes from a sample, you have to account for sampling error. In order to be safer around this remarks, you should calculate and plot the *confidence interval* along with the estimates. Let's do this, then:

```{r plot.ci.sy, echo=FALSE, message=FALSE, warning=FALSE}
dt <- final_list$overall %>% arrange( pct_Freq ) %>% 
  mutate( tooltip = paste0('<table><th>', round(100*pct_Freq , 1),'% (' , round(100*ci_l , 1) , '%;', round(100*ci_u , 1),'%)</th></table><tr><td>', area, '</td></tr>') ) %>%
  filter( agebreak == "4 to 17 years old" & year == 2015 )
ordplot <- dt$area[ order(dt$pct_Freq) ]
ordplot <- c( "Brazil", as.character( ordplot[ ordplot != "Brazil" ] ) )
ordplot <- rev(ordplot)
oa.rg <- ggplot( dt , 
                 aes(area, pct_Freq , group = area , color = area , tooltip = tooltip , onclick = "opacity=.3;" ) ) +
  geom_errorbar(aes(ymin=ci_l, ymax=ci_u), width=.1 , alpha = .5 ) +
  geom_point_interactive( size = 1) +
  scale_y_continuous( labels = percent , expand = c(0,0) , breaks = seq(.5,1,.025) ) +
  scale_x_discrete( limits = ordplot ) +
  coord_flip( ylim=c(.875,.975) ) +
  labs( x = "Regions" , y = "Percentage", 
        title = "Children and adolescents going to school" , 
        subtitle ="By region\nWith 95% confidence interval" , 
        caption = "Source: PNAD 2015. Microdata.") +
  scale_color_brewer(type = "qual" , palette = "Dark2" , direction = 1 ) +
  guides(color = FALSE ) +
  theme( panel.grid.major.y = element_line( colour = "lightgrey" , linetype = 3 ) ,  
         # panel.grid.major.y = element_blank() , 
         panel.background = element_rect( fill = "white" ) , 
         panel.grid.minor.x = element_blank() ,
         panel.grid.major.x = element_blank() , 
         plot.title = element_text(lineheight=.8, face="bold") ) 

ggiraph( code = {print(oa.rg)} , zoom_max = 5 , width = 1 , tooltip_opacity = .7 , width_svg = 8, height_svg= 4 )
```

With this graph, we see that we can't say that. Since the lower bound of South's CI is 92% while the upper bound of Center-west's is 92.9%, the two CIs overlap. Put simply, *they aren't significantly different*.

Let's try with another plot. The next graph shows the series of attendance rate by household income per capita, in classes of minimum wage. 

```{r income.ci.sy, echo=FALSE, message=FALSE, warning=FALSE}
dt <- final_list$income %>% 
  mutate( agebreak = factor( agebreak , levels(agebreak)[c(4,5,6,1,2,3)] ), 
          tooltip = paste0('<table><th>', round(100*pct_Freq , 1),'% (' , round(100*ci_l , 1) , '%;', round(100*ci_u , 1),'%)</th></table><tr><td>', area, '\n' , year , '</td></tr>') ) %>% 
  filter( agebreak == "4 to 17 years old" )
levels(dt$raca) <- c( "Less than the minimum wage" , "1 to 3 times the minimum wage" , "More than 3 times the minimum wage" )
inc.rg <- 
  ggplot( dt, aes( year, pct_Freq , group = interaction(area,raca) , color = raca , tooltip = tooltip ) ) +
  geom_line( alpha = .3 ) + geom_errorbar(aes(ymin=ci_l, ymax=ci_u), width=.1 , alpha = .5 ) +
  geom_point_interactive( data =dt %>% filter( pct_Freq >= .7 ) , size = 1 ) +
  scale_y_continuous( labels = percent , expand = c(0,0) ) +
  scale_x_continuous( breaks = 2005:2015, labels = 2005:2015 ) +
  coord_cartesian(ylim=c(.70 , 1) , xlim = c(2005,2015) ) +
  scale_color_brewer(type = "seq" , palette = 4 , direction = 1 ) +
  labs( x = "Years" , y = "Percentage", 
        title = "Children and adolescents going to school" , 
        subtitle ="By household income per capita\nWith 95% confidence interval" , 
        caption = "Source: PNAD 2005-2015. Microdata.\nNote: minimum wage in September of that year.") +
  #guides(color = guide_legend(title = "Regi√£o", title.position = "top"), linetype = guide_legend(title = "Cor/Ra√ßa", title.position = "top")) +
  guides(color = guide_legend(title = "Household income per capita", title.position = "top" , reverse = FALSE )) +
  facet_wrap(~area,  nrow = 2)+
  theme_dark() +
  theme( panel.grid.minor.x = element_blank() ,
         legend.position = "bottom",
         # axis.text.x = element_text(angle=-90, vjust=0.5) , # rotate x-axis labels 90 degrees
         axis.text.x = element_text(angle = 45, hjust = 1) , # rotate x-axis labels 45 degrees
         plot.title = element_text(lineheight=.8, face="bold") )

ggiraph( code = {print(inc.rg)} , zoom_max = 5 , width = 1 , tooltip_opacity = .7 , width_svg = 10, height_svg= 8 )
```

Cool, right? This one shows you that the *differences in access to education across different income levels are diminishing over time*. Yet, considering the entire country, children living in richer households are still more likely to be in school than those living in more deprived households, as the difference is still significant.

A question remain: **has educational inequality fallen**? This is an important discussion, but it is a topic for another post...