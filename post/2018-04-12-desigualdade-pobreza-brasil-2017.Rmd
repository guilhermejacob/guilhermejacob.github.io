---
title: "PNAD Contínua 2017: extrema pobreza na infância e desigualdade"
author: "Guilherme Jacob"
date: '2018-04-24'
slug: desigualdade-pobreza-infancia-2017
categories: [R, Complex Survey, Official Statistics]
tags: [Poverty, Inequality, Brazil]
draft: false
language: "pt-br"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set( message = FALSE, warning = FALSE, cache = TRUE )
```

<!--html_preserve-->
{{< alert warning >}}
<b>Atualização (19/05/2018):</b> passei a usar a nova tabela de deflatores, ajustando para preços médios do ano da pesquisa.<br>
<b>Atualização (20/05/2018):</b> fixei os valores a preços médios de 2017.
{{< /alert >}}
<!--/html_preserve-->

Interrompendo o meu hiato de alguns meses, resolvi voltar com uma comparação os dados de renda das PNADCs anuais 2016-2017. No entanto, vamos falar um pouco da desigualdade em geral e, então, partir para uma questão mais específica: pobreza na infância^[Para os fins deste post, infância é, na verdade, infância e adolescência, compreendendo o período do nascimento até os 18 anos incompletos.].

Mas, antes de tudo, um aviso:

<!--html_preserve-->
{{< alert warning >}}
Todos as estimativas a seguir foram feitas por mim.<br>Assim, nem IBGE, nem qualquer outra instituição tem responsabilidade a respeito dos meus comentários ou conclusões.
{{< /alert >}}
<!--/html_preserve-->

Nas análises abaixo, as rendas foram ajustadas para valores de julho de 2017, de modo que seja possível comparar as mesmas cestas de consumo. Sem mais delongas, vamos às estimativas!^[Todas as estimativas foram realizadas utilizando a *library* [`convey`](https://cran.r-project.org/web/packages/convey/index.html).]

```{r database_setup, message=FALSE, warning=FALSE, cache=TRUE, include=FALSE}
# carrega libraries
library(downloader)
library(readxl)
library(data.table)
library(fst)
library(survey)
library(convey)

# opções para a library `survey`
options( survey.lonely.psu = "adjust" )
options( survey.multicore = TRUE )

# define diretórios
output_dir <- "~/Bases/PNAD Contínua/Anual"

# set uf table
uf <-
  structure(list(V1 = c(11L, 12L, 13L, 14L, 15L, 16L, 17L, 21L, 
                        22L, 23L, 24L, 25L, 26L, 27L, 28L, 29L, 31L, 32L, 33L, 35L, 41L, 
                        42L, 43L, 50L, 51L, 52L, 53L), 
                 V2 = structure(c(22L, 1L, 4L, 
                                  23L, 14L, 3L, 27L, 10L, 18L, 6L, 20L, 15L, 17L, 2L, 26L, 5L, 
                                  13L, 8L, 19L, 25L, 16L, 24L, 21L, 12L, 11L, 9L, 7L), 
                                .Label = c("Acre", "Alagoas", "Amapá", "Amazonas", "Bahia", "Ceará", "Distrito Federal", 
                                           "Espírito Santo", "Goiás", "Maranhão", "Mato Grosso", "Mato Grosso do Sul", 
                                           "Minas Gerais", "Pará", "Paraíba", "Paraná", "Pernambuco", "Piauí", 
                                           "Rio de Janeiro", "Rio Grande do Norte", "Rio Grande do Sul", 
                                           "Rondônia", "Roraima", "Santa Catarina", "São Paulo", "Sergipe", 
                                           "Tocantins"), class = "factor")), .Names = c("uf", "uf_name"), 
            class = "data.frame", row.names = c(NA, -27L))
uf$cp_name <- c("Porto Velho" , "Rio Branco" , "Manaus", "Boa Vista", "Belém", "Macapá", "Palmas", "São Luís", "Teresina", 
                "Fortaleza" , "Natal", "João Pessoa" , "Recife" , "Maceió" , "Aracaju", "Salvador", "Belo Horizonte" , 
                "Vitória" , "Rio de Janeiro", "São Paulo" , "Curitiba", "Florianópolis" , "Porto Alegre", "Campo Grande", 
                "Cuiabá", "Goiânia" , "Brasília" )
uf$rg_name <- factor( substr( uf$uf , 1 , 1 ) , levels = 1:5 , labels = c( "Norte" , "Nordeste" , "Sudeste" , "Sul" , "Centro-Oeste" ) )




# monta tabela com deflatores
# faz download da tabela
tf <- tempfile()
download.file( "ftp://ftp.ibge.gov.br/Trabalho_e_Rendimento/Pesquisa_Nacional_por_Amostra_de_Domicilios_continua/Anual/Microdados/Documentacao/deflator_2017_pnadc.xls" , tf )

# lê arquivo do excel
deflat_tab <- read_xls( tf , sheet = 1 )

# converte para data.table
deflat_tab <- as.data.table( deflat_tab )

# ajusta nomes
colnames( deflat_tab ) <- tolower( colnames( deflat_tab ) )
colnames( deflat_tab )[ colnames( deflat_tab ) %in% "trim" ] <- "trimestre"

# transforma para preços médios de 2017:
deflat_tab[ , myp := sum( co1 ) / 4 , by = .( ano , uf ) ]
deflat_tab[ , myp_2016 := myp[ ano == 2017 ] , by = .( uf ) ]
deflat_tab[ , ratio := myp / myp_2016 ]
deflat_tab[ , deflt := co1 / ratio ]

# formata tabela
deflat_tab <- deflat_tab[ , c( "ano" , "trimestre" , "uf" , "deflt" ) , with = FALSE ]


# monta desenho amostral

# list files
these_files <- list.files( output_dir , full.names = TRUE , recursive = TRUE )

# filter for 2016-2017 data
these_files <- these_files[ grepl( "201(6|7) 1" , basename( these_files ) ) ]

# loop through files
these_results <- lapply( these_files, function(this_file) {
  
  # define columns to read
  these_columns <- c( "upa" , "estrato" , "v1031" , "v1030" , "posest" , "ano" , "trimestre" , "uf" , "capital" , "v2010" , "v2009" , "vd4016" , paste0( "vd500" , 1:6 ) , "v3002" , paste0( "vd402" , c(0,2) ) , "vd2002" , "v20082" )
  
  # read dataset
  pnadc_df <- read_fst( this_file , columns = these_columns , as.data.table = TRUE )
  
  # merge data
  pnadc_df <- merge( pnadc_df , uf , by = "uf" )
  
  # add one column
  pnadc_df[, one := 1]
  
  # add age column
  pnadc_df[, age := ifelse( !is.na( v20082 ) , 2016 - v20082 , NA ) ]
  
  # create region
  pnadc_df[, regiao := substr( uf , 1 , 1 )]
  
  # combina deflator
  pnadc_df <- merge( pnadc_df , deflat_tab , by = c( "ano" , "trimestre" , "uf" ) , all.x = TRUE , all.y = FALSE )
  
  # deflaciona os rendas
  these_inc_cols <- c( paste0( "vd500" , c(1:2,4:5) ) , paste0( "vd402" , c(0,2) ) )
  pnadc_df[ , paste0( "def_" , these_inc_cols ) := lapply( .SD , function(x) x * deflt ) , .SDcols = these_inc_cols ]
  
  # preliminary survey design
  pre_stratified <-
    svydesign(
      ids = ~ upa , 
      strata = ~ estrato , 
      weights = ~ v1031 , 
      data = pnadc_df ,
      nest = TRUE
    )
  # warning: do not use `pre_stratified` in your analyses!
  # you must use the `pnadc_design` object created below.
  
  # post-stratification targets
  df_pos <- data.frame( posest = unique( pnadc_df$posest ) , Freq = unique( pnadc_df$v1030 ) )
  
  # final survey design object
  pnadc_design <- postStratify( pre_stratified , ~ posest , df_pos )
  
  # remove the `pnadc_df` data.frame object
  # and the `pre_stratified` design before stratification
  rm( pnadc_df , pre_stratified , df_pos )
  
  # aplica convey
  pnadc_design <- convey_prep( pnadc_design )
  
  # crianças e adolescentes
  pnadc_design_chld <- subset( pnadc_design , age <= 17 )
  
  # desenho especial abrinq
  pnadc_design_chld_abrinq <- subset( pnadc_design , age <= 14 )
  
  # estima índice de gini
  br_gini <- svyby( ~def_vd5002 , ~one , pnadc_design , svygini , na.rm = TRUE )
  rg_gini <- svyby( ~def_vd5002 , ~rg_name , pnadc_design , svygini , na.rm = TRUE )
  # uf_gini <- svyby( ~def_vd5002 , ~uf_name , pnadc_design , svygini , na.rm = TRUE )
  # cp_gini <- svyby( ~def_vd5002 , ~cp_name , pnadc_design , svygini , na.rm = TRUE )
  
  # res1 <- list( br_gini , rg_gini , uf_gini , cp_gini )
  res1 <- list( br_gini , rg_gini )
  
  # build result set
  res1 <- lapply( res1 , function( x ) {
    this_est <- data.frame( x ) 
    colnames( this_est )[1] <- c( "area" )
    
    this_ci <- data.frame( confint( x ) )
    colnames( this_ci ) <- c( "ci_l" , "ci_u" ) 
    
    this_cv <- data.frame( cv( x ) )
    colnames( this_cv ) <- "cv"
    
    this_result <- cbind( set = names( x[1] ), this_est , this_ci , this_cv )
    rownames( this_result ) <- NULL
    
    if ( length( this_result$set ) == 1 & ( "one" %in% this_result$set ) ) this_result$area <- "Brasil"
    
    this_result
  } )
  res1 <- do.call( rbind , res1 )
  
  # estima índices de palma
  br_palma <- svyby( ~def_vd5002 , ~one , pnadc_design , svyqsr , alpha2 = .1 , alpha1 = .4 , na.rm = TRUE )
  rg_palma <- svyby( ~def_vd5002 , ~rg_name , pnadc_design , svyqsr , alpha2 = .1 , alpha1 = .4 , na.rm = TRUE )
  # uf_palma <- svyby( ~def_vd5002 , ~uf_name , pnadc_design , svyqsr , alpha2 = .1 , alpha1 = .4 , na.rm = TRUE )
  # cp_palma <- svyby( ~def_vd5002 , ~cp_name , pnadc_design , svyqsr , alpha2 = .1 , alpha1 = .4 , na.rm = TRUE )
  
  # res2 <- list( br_palma , rg_palma , uf_palma , cp_palma )
  res2 <- list( br_palma , rg_palma )
  
  # build result set
  res2 <- lapply( res2 , function( x ) {
    this_est <- data.frame( x ) 
    colnames( this_est )[1] <- c( "area" )
    
    this_ci <- data.frame( confint( x ) )
    colnames( this_ci ) <- c( "ci_l" , "ci_u" ) 
    
    this_cv <- data.frame( cv( x ) )
    colnames( this_cv ) <- "cv"
    
    this_result <- cbind( set = names( x[1] ), this_est , this_ci , this_cv )
    rownames( this_result ) <- NULL
    
    if ( length( this_result$set ) == 1 & ( "one" %in% this_result$set ) ) this_result$area <- "Brasil"
    
    this_result
  } )
  res2 <- do.call( rbind , res2 )
  
  # estima fgt0
  br_fgt0 <- svyby( ~def_vd5002 , ~one , pnadc_design_chld , svyfgt , g = 0 , abs_thresh = 235 , na.rm = TRUE )
  rg_fgt0 <- svyby( ~def_vd5002 , ~rg_name , pnadc_design_chld , svyfgt , g = 0 , abs_thresh = 235 , na.rm = TRUE )
  # uf_fgt0 <- svyby( ~def_vd5002 , ~uf_name , pnadc_design , svyfgt , g = 0 , abs_thresh = 235 , na.rm = TRUE )
  # cp_fgt0 <- svyby( ~def_vd5002 , ~cp_name , pnadc_design , svyfgt , g = 0 , abs_thresh = 235 , na.rm = TRUE )
  
  # res4 <- list( br_fgt0 , rg_fgt0 , uf_fgt0 , cp_fgt0 )
  res4 <- list( br_fgt0 , rg_fgt0 )
  
  # build result set
  res4 <- lapply( res4 , function( x ) {
    this_est <- data.frame( x ) 
    colnames( this_est )[1] <- c( "area" )
    
    this_ci <- data.frame( confint( x ) )
    colnames( this_ci ) <- c( "ci_l" , "ci_u" ) 
    
    this_cv <- data.frame( cv( x ) )
    colnames( this_cv ) <- "cv"
    
    this_result <- cbind( set = names( x[1] ), this_est , this_ci , this_cv )
    rownames( this_result ) <- NULL
    
    if ( length( this_result$set ) == 1 & ( "one" %in% this_result$set ) ) this_result$area <- "Brasil"
    
    this_result
  } )
  res4 <- do.call( rbind , res4 )
  
  
  # estima fgt1
  br_fgt1 <- svyby( ~def_vd5002 , ~one , pnadc_design_chld , svyfgt , g = 1 , abs_thresh = 235 , na.rm = TRUE )
  rg_fgt1 <- svyby( ~def_vd5002 , ~rg_name , pnadc_design_chld , svyfgt , g = 1 , abs_thresh = 235 , na.rm = TRUE )
  # uf_fgt1 <- svyby( ~def_vd5002 , ~uf_name , pnadc_design , svyfgt , g = 1 , abs_thresh = 235 , na.rm = TRUE )
  # cp_fgt1 <- svyby( ~def_vd5002 , ~cp_name , pnadc_design , svyfgt , g = 1 , abs_thresh = 235 , na.rm = TRUE )
  
  # res5 <- list( br_fgt1 , rg_fgt1 , uf_fgt1 , cp_fgt1 )
  res5 <- list( br_fgt1 , rg_fgt1 )
  
  # build result set
  res5 <- lapply( res5 , function( x ) {
    this_est <- data.frame( x ) 
    colnames( this_est )[1] <- c( "area" )
    
    this_ci <- data.frame( confint( x ) )
    colnames( this_ci ) <- c( "ci_l" , "ci_u" ) 
    
    this_cv <- data.frame( cv( x ) )
    colnames( this_cv ) <- "cv"
    
    this_result <- cbind( set = names( x[1] ), this_est , this_ci , this_cv )
    rownames( this_result ) <- NULL
    
    if ( length( this_result$set ) == 1 & ( "one" %in% this_result$set ) ) this_result$area <- "Brasil"
    
    this_result
  } )
  res5 <- do.call( rbind , res5 )
  
  # estima fgt2
  br_fgt2 <- svyby( ~def_vd5002 , ~one , pnadc_design_chld , svyfgt , g = 2 , abs_thresh = 235 , na.rm = TRUE )
  rg_fgt2 <- svyby( ~def_vd5002 , ~rg_name , pnadc_design_chld , svyfgt , g = 2 , abs_thresh = 235 , na.rm = TRUE )
  # uf_fgt2 <- svyby( ~def_vd5002 , ~uf_name , pnadc_design , svyfgt , g = 2 , abs_thresh = 235 , na.rm = TRUE )
  # cp_fgt2 <- svyby( ~def_vd5002 , ~cp_name , pnadc_design , svyfgt , g = 2 , abs_thresh = 235 , na.rm = TRUE )
  
  # res6 <- list( br_fgt2 , rg_fgt2 , uf_fgt2 , cp_fgt2 )
  res6 <- list( br_fgt2 , rg_fgt2 )
  
  # build result set
  res6 <- lapply( res6 , function( x ) {
    this_est <- data.frame( x ) 
    colnames( this_est )[1] <- c( "area" )
    
    this_ci <- data.frame( confint( x ) )
    colnames( this_ci ) <- c( "ci_l" , "ci_u" ) 
    
    this_cv <- data.frame( cv( x ) )
    colnames( this_cv ) <- "cv"
    
    this_result <- cbind( set = names( x[1] ), this_est , this_ci , this_cv )
    rownames( this_result ) <- NULL
    
    if ( length( this_result$set ) == 1 & ( "one" %in% this_result$set ) ) this_result$area <- "Brasil"
    
    this_result
  } )
  res6 <- do.call( rbind , res6 )
  
  # return results
  list( list( res1 , res2 , res4 , res5 , res6 ) , pnadc_design_chld_abrinq )
  
})


# save estimates
est2016 <- these_results[[1]][[1]]
est2017 <- these_results[[2]][[1]]

# save special design
pnadc_design_chld_abrinq <- these_results[[2]][[2]]

# clean workspace
rm( these_results ) ; gc()
```

### Desigualdade

Medindo pelo índice de Gini, a desigualdade no país se manteve estável. Entretanto, as estimativas pontuais parecem ter aumentado em 4 das 5 regiões, mas essas variações não são *estatisticamente significativas*, i.e., podem ser apenas erros amostrais.

```{r gini_plot, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE, cache=FALSE}
gini_stack <- rbind( cbind( year = 2016 , est2016[[1]] ) , cbind( year = 2017 , est2017[[1]] ) )
gini_stack$year <- factor( gini_stack$year )

library(dplyr)
library(tidyr)
library(ggplot2)

plot.order <- gini_stack %>% select( year , area , def_vd5002 )
plot.order <- rbind( plot.order[ plot.order[ , "area" ] == "Brasil" , ] , plot.order[ plot.order[ , "area" ] != "Brasil" , ] )
plot.order <- plot.order[ , "area" ]
plot.order <- unique( plot.order )

gini_scale <- function(x) gsub( ".*\\." , "." , sprintf('%.3f', x ) )

ggplot( gini_stack , aes( area , def_vd5002 , group = year ) ) + 
  geom_bar( aes(fill = year ) , stat = "identity", position = "dodge" , alpha = .8) +
  # geom_line( alpha = .3 ) + 
  geom_errorbar( aes(ymin=ci_l, ymax=ci_u , alpha = year ), width=.25 , position = position_dodge(.9) , color = "#FF9900" ) +
  # geom_errorbar(aes( ymin=ci_l, ymax=ci_u , color = year ), width=.25 , position = position_dodge(.8) , alpha = .9 ) +
  scale_y_continuous( breaks = seq(0,1,.2) , labels = gini_scale( seq(0,1,.2) ) , expand = c(0,0) , limits = c(NA , .75) ) +
  scale_x_discrete( limits = ( plot.order ) ) +
  # scale_fill_manual( values = c( "#222f44" , "#78b0f5" ) ) +
  scale_fill_manual( values = c( "#222f44" , "#599ef3" ) ) +
  scale_alpha_manual( values = c( .6 , 1 ) ) +
  # coord_equal( ylim=c(.3 , .7) ) +
  labs( x = NULL , y = "Índice de Gini", 
        title = "Índice de Gini da Renda Domiciliar Per Capita" , 
        subtitle ="Brasil e Grandes Regiões, 2016-2017.\nCom intervalo de confiança de 95%." ,
        caption = "Fonte: PNAD Contínua 2016-2017. Microdados.") +
  # scale_color_brewer(type = "qual" , palette = "Dark2" , direction = 1 ) +
  guides( color = FALSE , fill = guide_legend(title = "Ano") , alpha = FALSE ) +
  # theme_dark() +
  theme( panel.background = element_blank() ,
         panel.grid.major.x = element_blank() ,
         # panel.grid.minor.x = element_blank() , 
         # panel.grid.minor.x = element_line( linetype = 3 , color = "lightgrey" , size = .2 ) ,
         panel.grid.major.y = element_line( linetype = 3 , color = "grey" , size = .2 ) ,
         # axis.text.x = element_text(angle = 90, hjust = 1 , vjust = .5 ) ,
         plot.title = element_text(lineheight=.8, face="bold") )
```

E, a propósito, podemos ver que os números coincidem com [esta publicação do IBGE](https://biblioteca.ibge.gov.br/visualizacao/livros/liv101559_informativo.pdf):

```{r echo=FALSE, message=FALSE, warning=FALSE , results="asis" , cache=FALSE}
# reproduz publicação: https://biblioteca.ibge.gov.br/visualizacao/livros/liv101559_informativo.pdf
gini_table <- gini_stack %>% 
  select( year , area , def_vd5002 ) %>% 
  spread( year , def_vd5002 )
# gini_table <- gini_table [ , -2 ]
gini_table <- gini_table [ match(plot.order, gini_table$area) , ]
# knitr::kable( gini_table , format = "html" , digits = 3 , col.names = c( "" , "Gini" ) , caption = "Índice de Gini, 2016-2017 - Brasil e Grandes Regiões" )
library(knitr)
library(kableExtra)
kable( gini_table , format = "html" , digits = 3 , col.names = c( "" , "2016" , "2017" ) , row.names = FALSE ) %>% 
  add_header_above( c(" " = 1, "Gini" = 2 ) ) %>%
  footnote(general = "PNAD Contínua 2016-2017, suplemento anual. Microdados.", general_title = "Fonte:" , footnote_as_chunk = T )
```

Como sabemos, o índice de Gini não é a única medida de desigualdade. Ele também tende a ser mais sensível às desigualdades no centro da distribuição. Vamos, então, complementar nossa análise com o índice de Palma. As conclusões são similares, ainda que a estimativa pontual deste índice para o Brasil mostre um pequeno aumento de 2016 para 2017. Além disso, variação no nordeste se torna mais significativa, embora não o suficiente para afirmarmos que é estatisticamente significativa. 

```{r palma_plot, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE, cache=FALSE}
palma_stack <- rbind( cbind( year = 2016 , est2016[[2]] ) , cbind( year = 2017 , est2017[[2]] ) )
palma_stack$year <- factor( palma_stack$year )

library(dplyr)
library(tidyr)
library(ggplot2)

plot.order <- palma_stack %>% select( year , area , def_vd5002 )
plot.order <- rbind( plot.order[ plot.order[ , "area" ] == "Brasil" , ] , plot.order[ plot.order[ , "area" ] != "Brasil" , ] )
plot.order <- plot.order[ , "area" ]
plot.order <- unique( plot.order )

ggplot( palma_stack , aes( area , def_vd5002 , group = year ) ) + 
  geom_bar( aes(fill = year ) , stat = "identity", position = "dodge" , alpha = .8 ) +
  # geom_line( alpha = .3 ) + 
  geom_errorbar( aes(ymin=ci_l, ymax=ci_u , alpha = year ), width=.25 , position = position_dodge(.9) , color = "#FF9900" ) +
  # geom_errorbar(aes( ymin=ci_l, ymax=ci_u , color = year ), width=.25 , position = position_dodge(.8) , alpha = .9 ) +
  scale_y_continuous( expand = c(0,0) , limits = c(NA , 13) , breaks = seq( 0 , 20 , 3 ) ) +
  scale_x_discrete( limits = ( plot.order ) ) +
  # scale_fill_manual( values = c( "#222f44" , "#78b0f5" ) ) +
  scale_fill_manual( values = c( "#222f44" , "#599ef3" ) ) +
  scale_alpha_manual( values = c( .6 , 1 ) ) +
  # coord_equal( ylim=c(.3 , .7) ) +
  labs( x = NULL , y = "Índice de Palma", 
        title = "Índice de Palma da Renda Domiciliar Per Capita" , 
        subtitle ="Brasil e Grandes Regiões, 2016-2017.\nCom intervalo de confiança de 95%." ,
        caption = "Fonte: PNAD Contínua 2016-2017. Microdados.") +
  # scale_color_brewer(type = "qual" , palette = "Dark2" , direction = 1 ) +
  guides( color = FALSE , fill = guide_legend(title = "Ano") , alpha = FALSE ) +
  # theme_dark() +
  theme( panel.background = element_blank() ,
         panel.grid.major.x = element_blank() ,
         # panel.grid.minor.x = element_blank() , 
         # panel.grid.minor.x = element_line( linetype = 3 , color = "lightgrey" , size = .2 ) ,
         panel.grid.major.y = element_line( linetype = 3 , color = "grey" , size = .2 ) ,
         # axis.text.x = element_text(angle = 90, hjust = 1 , vjust = .5 ) ,
         plot.title = element_text(lineheight=.8, face="bold") )
```

### Pobreza na Infância

Antes de olhar as estatísticas, é importante esclarecer algumas questões metodológicas. Como já foi dito anteriormente, as rendas de 2016 e 2017 foram ajustadas para preços médios de 2017, permitindo que os valores sejam comparáveis entre si. Além disso, fixei a linha de pobreza em R$ 235.00, o equivalente a 1/4 do salário mínimo de 2017. De fato, esta linha costuma ser chamada de "linha de pobreza extrema", enquanto 1/2 s.m. seria a linha de pobreza propriamente dita. Vamos prosseguir com essa nomenclatura.

No sudeste, uma das regiões mais ricas do país, mesmo com desigualdade (geral) praticamente estável, há um indício de piora deste indicador. O norte, por outro lado, parece apresentar uma leve queda. Isto acaba por diferenciar norte e nordeste, apontando com mais claridade o segundo como a pior região em termos de extrema pobreza na infância.

```{r fgt0_plot, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE, cache=FALSE}
fgt0_stack <- rbind( cbind( year = 2016 , est2016[[3]] ) , cbind( year = 2017 , est2017[[3]] ) )
fgt0_stack$year <- factor( fgt0_stack$year )

library(dplyr)
library(tidyr)
library(ggplot2)

plot.order <- fgt0_stack %>% select( year , area , def_vd5002 )
plot.order <- plot.order %>% arrange( rev( year ) )
plot.order <- rbind( plot.order[ plot.order[ , "area" ] == "Brasil" , ] , plot.order[ plot.order[ , "area" ] != "Brasil" , ] )
plot.order <- plot.order[ , "area" ]
plot.order <- unique( plot.order )

ggplot( fgt0_stack , aes( area , def_vd5002 , group = year ) ) + 
  geom_bar( aes(fill = year ) , stat = "identity", position = "dodge" , alpha = .8) +
  # geom_line( alpha = .3 ) + 
  geom_errorbar( aes(ymin=ci_l, ymax=ci_u , alpha = year ), width=.25 , position = position_dodge(.9) , color = "#FF9900" ) +
  # geom_errorbar(aes( ymin=ci_l, ymax=ci_u , color = year ), width=.25 , position = position_dodge(.8) , alpha = .9 ) +
  scale_y_continuous( labels = scales::percent , breaks = seq(0 , 1 , .05 ) , limits = c(0, .42) , expand = c(0,0) ) +
  scale_x_discrete( limits = ( plot.order ) ) +
  # scale_fill_manual( values = c( "#222f44" , "#78b0f5" ) ) +
  scale_fill_manual( values = c( "#222f44" , "#599ef3" ) ) +
  scale_alpha_manual( values = c( .6 , 1 ) ) +
  # coord_equal( ylim=c(.3 , .7) ) +
  labs( x = NULL , y = "Taxa de Pobreza Extrema", 
        title = "Taxa de pobreza extrema entre crianças e adolescentes" , 
        subtitle ="Brasil e Grandes Regiões, 2016-2017.\nLinha de Pobreza: R$ 235.00 a preços médios de 2017.\nCom intervalo de confiança de 95%." ,
        caption = "Fonte: PNAD Contínua 2016-2017. Microdados.") +
  # scale_color_brewer(type = "qual" , palette = "Dark2" , direction = 1 ) +
  guides( color = FALSE , fill = guide_legend(title = "Ano") , alpha = FALSE ) +
  # theme_dark() +
  theme( panel.background = element_blank() ,
         panel.grid.major.x = element_blank() ,
         # panel.grid.minor.x = element_blank() , 
         # panel.grid.minor.x = element_line( linetype = 3 , color = "lightgrey" , size = .2 ) ,
         panel.grid.major.y = element_line( linetype = 3 , color = "grey" , size = .2 ) ,
         # axis.text.x = element_text(hjust = .5 , vjust = .5 ) ,
         plot.title = element_text(lineheight=.8, face="bold") )
```

A intensidade da pobreza extrema na infância se manteve estável: o hiato de pobreza foi de 9.3% para 9%, variação sem significância estatística. Quanto às regiões, as variação também não foram estatisticamente significantes. Entretanto, a região norte apresenta uma leve melhora no indicador.  
O sul merece uma atenção especial. Nesta região, a taxa de pobreza diminiu, mas o hiato de pobreza aumentou levemente. Esses movimentos divergente parece apontar que quem saiu da pobreza estava mais próximo da linha de pobreza. Desta forma, a proporção de pessoas abaixo da linha cai, mas a intensidade dos hiatos renda-linha, em média, aumentam.

```{r fgt1_plot, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE , cache=FALSE}
fgt1_stack <- rbind( cbind( year = 2016 , est2016[[4]] ) , cbind( year = 2017 , est2017[[4]] ) )
fgt1_stack$year <- factor( fgt1_stack$year )

library(dplyr)
library(tidyr)
library(ggplot2)

plot.order <- fgt1_stack %>% select( year , area , def_vd5002 )
plot.order <- plot.order %>% arrange( rev( year ) )
plot.order <- rbind( plot.order[ plot.order[ , "area" ] == "Brasil" , ] , plot.order[ plot.order[ , "area" ] != "Brasil" , ] )
plot.order <- plot.order[ , "area" ]
plot.order <- unique( plot.order )

ggplot( fgt1_stack , aes( area , def_vd5002 , group = year ) ) + 
  geom_bar( aes(fill = year ) , stat = "identity", position = "dodge" , alpha = .8) +
  # geom_line( alpha = .3 ) + 
  geom_errorbar( aes(ymin=ci_l, ymax=ci_u , alpha = year ), width=.25 , position = position_dodge(.9) , color = "#FF9900" ) +
  # geom_errorbar(aes( ymin=ci_l, ymax=ci_u , color = year ), width=.25 , position = position_dodge(.8) , alpha = .9 ) +
  scale_y_continuous( labels = scales::percent , breaks = seq(0 , 1 , .05 ) , limits = c(0, .17) , expand = c(0,0) ) +
  scale_x_discrete( limits = ( plot.order ) ) +
  # scale_fill_manual( values = c( "#222f44" , "#78b0f5" ) ) +
  scale_fill_manual( values = c( "#222f44" , "#599ef3" ) ) +
  scale_alpha_manual( values = c( .6 , 1 ) ) +
  # coord_equal( ylim=c(.3 , .7) ) +
  labs( x = NULL , y = "Hiato de Pobreza", 
        title = "Hiato de pobreza entre crianças e adolescentes" , 
        subtitle ="Brasil e Grandes Regiões, 2016-2017.\nLinha de Pobreza: R$ 235.00 a preços médios de 2017.\nCom intervalo de confiança de 95%." ,
        caption = "Fonte: PNAD Contínua 2016-2017. Microdados.") +
  # scale_color_brewer(type = "qual" , palette = "Dark2" , direction = 1 ) +
  guides( color = FALSE , fill = guide_legend(title = "Ano") , alpha = FALSE ) +
  # theme_dark() +
  theme( panel.background = element_blank() ,
         panel.grid.major.x = element_blank() ,
         # panel.grid.minor.x = element_blank() , 
         # panel.grid.minor.x = element_line( linetype = 3 , color = "lightgrey" , size = .2 ) ,
         panel.grid.major.y = element_line( linetype = 3 , color = "grey" , size = .2 ) ,
         panel.grid.minor.y = element_line( linetype = 3 , color = "grey" , size = .1 ) ,
         # axis.text.x = element_text(hjust = .5 , vjust = .5 ) ,
         plot.title = element_text(lineheight=.8, face="bold") )
```

O hiato quadrático de pobreza indica que a desigualdade entre as crianças e adolescentes em extrema pobreza aumentou. No caso do Brasil, ainda que a taxa de pobreza extrema entre crianças e adolescentes se mostre estável, as variações de renda foram regressivas: quem estava ruim ficou ainda pior. Esta variação foi sentida em 4 das 5 regiões. Novamente, o nordeste merece destaque: de todas as regiões, esta apresentou a variação mais significativa, consolidando o pior lugar segundo este indicador.

```{r fgt2_plot, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE , cache=FALSE}
fgt2_stack <- rbind( cbind( year = 2016 , est2016[[5]] ) , cbind( year = 2017 , est2017[[5]] ) )
fgt2_stack$year <- factor( fgt2_stack$year )

library(dplyr)
library(tidyr)
library(ggplot2)

plot.order <- fgt2_stack %>% select( year , area , def_vd5002 )
plot.order <- plot.order %>% arrange( rev( year ) )
plot.order <- rbind( plot.order[ plot.order[ , "area" ] == "Brasil" , ] , plot.order[ plot.order[ , "area" ] != "Brasil" , ] )
plot.order <- plot.order[ , "area" ]
plot.order <- unique( plot.order )

ggplot( fgt2_stack , aes( area , def_vd5002 , group = year ) ) + 
  geom_bar( aes(fill = year ) , stat = "identity", position = "dodge" , alpha = .8) +
  # geom_line( alpha = .3 ) + 
  geom_errorbar( aes(ymin=ci_l, ymax=ci_u , alpha = year ), width=.25 , position = position_dodge(.9) , color = "#FF9900" ) +
  # geom_errorbar(aes( ymin=ci_l, ymax=ci_u , color = year ), width=.25 , position = position_dodge(.8) , alpha = .9 ) +
  scale_y_continuous( labels = scales::percent , breaks = seq(0 , 1 , .025 ) , limits = c(0, .13) , expand = c(0,0) ) +
  scale_x_discrete( limits = ( plot.order ) ) +
  # scale_fill_manual( values = c( "#222f44" , "#78b0f5" ) ) +
  scale_fill_manual( values = c( "#222f44" , "#599ef3" ) ) +
  scale_alpha_manual( values = c( .6 , 1 ) ) +
  # coord_equal( ylim=c(.3 , .7) ) +
  labs( x = NULL , y = "Hiato Quadrático de Pobreza", 
        title = "Hiato quadrático de pobreza entre crianças e adolescentes" , 
        subtitle ="Brasil e Grandes Regiões, 2016-2017.\nLinha de Pobreza: R$ 235.00 a preços médios de 2017.\nCom intervalo de confiança de 95%." ,
        caption = "Fonte: PNAD Contínua 2016-2017. Microdados.") +
  # scale_color_brewer(type = "qual" , palette = "Dark2" , direction = 1 ) +
  guides( color = FALSE , fill = guide_legend(title = "Ano") , alpha = FALSE ) +
  # theme_dark() +
  theme( panel.background = element_blank() ,
         panel.grid.major.x = element_blank() ,
         # panel.grid.minor.x = element_blank() , 
         # panel.grid.minor.x = element_line( linetype = 3 , color = "lightgrey" , size = .2 ) ,
         panel.grid.major.y = element_line( linetype = 3 , color = "grey" , size = .2 ) ,
         # panel.grid.minor.y = element_line( linetype = 3 , color = "grey" , size = .1 ) ,
         # axis.text.x = element_text(hjust = .5 , vjust = .5 ) ,
         plot.title = element_text(lineheight=.8, face="bold") )
```

### Concluindo

Em geral, a conclusão é simples: aquilo que não se manteve estável, definitivamente piorou. Isso revela um pouco do impacto da crise sobre as crianças e adolescentes no Brasil. Resta saber como a economia, no advento de sua recuperação, irá afetar esta população.

Para compor com o clima deprimente deste post, vamos ouvir Daíra cantando Belchior. Nesse mundo de *pessoas cinzas normais* e *humilhados do parque com os seus jornais*, vale lembrar que *amar e mudar as coisas* interessa mais.

<!--html_preserve-->
<br>
<div style="position:relative;height:0;padding-bottom:56.21%"><iframe src="https://www.youtube.com/embed/f3oO_-rqOo4?ecver=2" style="position:absolute;width:100%;height:100%;left:0" width="641" height="360" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div>
<!--/html_preserve-->

### Um pós-escrito sobre o "Cenário da Infância e Adolescência no Brasil 2018"

Hoje também saiu o [Cenário da Infância e Adolescência no Brasil 2018](https://issuu.com/fundacaoabrinq/docs/cenario_da_infancia_2018_internet), da Fundação Abrinq. As principais manchetes falam que "40% das crianças e adolescentes até 14 anos vivem em situação de pobreza". Os dados foram estimados com a PNAD 2015. Embora as coisas não se comparem muito bem entre PNAD e PNADC, vamos tentar calcular estimativas mais recentes.

Nossas contas mostram que 43% das crianças e adolescentes^[Aqui estamos usando a definição da Abrinq, de até 14 anos.] estão vivendo em situação de pobreza no Brasil. E a constatação de que essa proporção sobe para 61% e 59% no nordeste e norte, respectivamente, é absolutamente aterradora.

```{r abrinq_plot_rg, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE , cache=FALSE}
library(survey)
library(convey)

# estima fgt0
br_fgt0 <- svyby( ~def_vd5002 , ~one , pnadc_design_chld_abrinq , svyfgt , g = 0 , abs_thresh = 468.5 , na.rm = TRUE )
rg_fgt0 <- svyby( ~def_vd5002 , ~rg_name , pnadc_design_chld_abrinq , svyfgt , g = 0 , abs_thresh = 468.5 , na.rm = TRUE )
uf_fgt0 <- svyby( ~def_vd5002 , ~uf_name , pnadc_design_chld_abrinq , svyfgt , g = 0 , abs_thresh = 468.5 , na.rm = TRUE )

res1 <- list( br_fgt0 , rg_fgt0 , uf_fgt0 )

# build result set
res1 <- lapply( res1 , function( x ) {
  this_est <- data.frame( x ) 
  colnames( this_est )[1] <- c( "area" )
  
  this_ci <- data.frame( confint( x ) )
  colnames( this_ci ) <- c( "ci_l" , "ci_u" ) 
  
  this_cv <- data.frame( cv( x ) )
  colnames( this_cv ) <- "cv"
  
  this_result <- cbind( set = names( x[1] ), this_est , this_ci , this_cv )
  rownames( this_result ) <- NULL
  
  if ( length( this_result$set ) == 1 & ( "one" %in% this_result$set ) ) this_result$area <- "Brasil"
  
  this_result
} )
fgt0_stack <- do.call( rbind , res1 )

fgt0_stack <- cbind( year = 2017 , fgt0_stack )
fgt0_stack <- fgt0_stack %>% filter( set %in% c( "one" , "rg_name" ) )
fgt0_stack$year <- factor( fgt0_stack$year )

plot.order <- fgt0_stack %>% select( year , area , def_vd5002 )
plot.order <- plot.order %>% arrange( rev( year ) )
plot.order <- rbind( plot.order[ plot.order[ , "area" ] == "Brasil" , ] , plot.order[ plot.order[ , "area" ] != "Brasil" , ] )
plot.order <- plot.order[ , "area" ]
plot.order <- unique( plot.order )

ggplot( fgt0_stack , aes( area , def_vd5002 , group = year ) ) + 
  geom_bar( aes(fill = year ) , stat = "identity", position = "dodge" , alpha = .8) +
  # geom_line( alpha = .3 ) + 
  geom_errorbar( aes(ymin=ci_l, ymax=ci_u , alpha = year ), width=.25 , position = position_dodge(.9) , color = "#FF9900" ) +
  # geom_errorbar(aes( ymin=ci_l, ymax=ci_u , color = year ), width=.25 , position = position_dodge(.8) , alpha = .9 ) +
  scale_y_continuous( labels = scales::percent , breaks = seq(0 , 1 , .05 ) , limits = c(0, .72) , expand = c(0,0) ) +
  scale_x_discrete( limits = ( plot.order ) ) +
  # scale_fill_manual( values = c( "#222f44" , "#78b0f5" ) ) +
  scale_fill_manual( values = c( "#222f44" , "#599ef3" ) ) +
  scale_alpha_manual( values = c( .6 , 1 ) ) +
  # coord_equal( ylim=c(.3 , .7) ) +
  labs( x = NULL , y = "Taxa de Pobreza", 
        title = "Taxa de pobreza entre crianças e adolescentes até 14 anos" , 
        subtitle ="Brasil e Grandes Regiões, 2017.\nLinha de Pobreza: R$ 468.50 a preços médios de 2017.\nCom intervalo de confiança de 95%." ,
        caption = "Fonte: PNAD Contínua 2017. Microdados.") +
  # scale_color_brewer(type = "qual" , palette = "Dark2" , direction = 1 ) +
  guides( color = FALSE , fill = FALSE , alpha = FALSE ) +
  # theme_dark() +
  theme( panel.background = element_blank() ,
         panel.grid.major.x = element_blank() ,
         # panel.grid.minor.x = element_blank() , 
         # panel.grid.minor.x = element_line( linetype = 3 , color = "lightgrey" , size = .2 ) ,
         panel.grid.major.y = element_line( linetype = 3 , color = "grey" , size = .2 ) ,
         panel.grid.minor.y = element_line( linetype = 3 , color = "grey" , size = .1 ) ,
         # axis.text.x = element_text(hjust = .5 , vjust = .5 ) ,
         plot.title = element_text(lineheight=.8, face="bold") )
```

Piauí, Maranhão e Amazonas são os 3 piores estados, com quase 70% das crianças e adolescentes até 14 anos em situação de pobreza.

```{r fgt0_abrinq_uf, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE, cache=FALSE}
fgt0_stack <- do.call( rbind , res1 )

fgt0_stack <- cbind( year = 2017 , fgt0_stack )
fgt0_stack <- fgt0_stack %>% filter( set %in% c( "one" , "uf_name" ) )
fgt0_stack$year <- factor( fgt0_stack$year )

plot.order <- fgt0_stack %>% select( year , area , def_vd5002 )
# plot.order <- plot.order %>% arrange( rev( year ) )
plot.order <- plot.order %>% arrange( desc( def_vd5002 ) )
plot.order <- rbind( plot.order[ plot.order[ , "area" ] == "Brasil" , ] , plot.order[ plot.order[ , "area" ] != "Brasil" , ] )
plot.order <- plot.order[ , "area" ]
plot.order <- unique( plot.order )

ggplot( fgt0_stack , aes( area , def_vd5002 , group = year ) ) + 
  geom_bar( aes(fill = year ) , stat = "identity", position = "dodge" , alpha = .8) +
  # geom_line( alpha = .3 ) + 
  geom_errorbar( aes(ymin=ci_l, ymax=ci_u , alpha = year ), width=.25 , position = position_dodge(.9) , color = "#FF9900" ) +
  # geom_errorbar(aes( ymin=ci_l, ymax=ci_u , color = year ), width=.25 , position = position_dodge(.8) , alpha = .9 ) +
  scale_y_continuous( labels = scales::percent , breaks = seq(0 , 1 , .1 ) , limits = c(0, .82) , expand = c(0,0) ) +
  scale_x_discrete( limits = ( plot.order ) ) +
  # scale_fill_manual( values = c( "#222f44" , "#78b0f5" ) ) +
  scale_fill_manual( values = c( "#222f44" , "#599ef3" ) ) +
  scale_alpha_manual( values = c( .6 , 1 ) ) +
  # coord_equal( ylim=c(.3 , .7) ) +
  labs( x = NULL , y = "Taxa de Pobreza", 
        title = "Taxa de pobreza entre crianças e adolescentes até 14 anos" , 
        subtitle ="Brasil e UFs, 2017.\nLinha de Pobreza: R$ 468.50 de Julho/2017.\nCom intervalo de confiança de 95%." ,
        caption = "Fonte: PNAD Contínua 2017. Microdados.") +
  # scale_color_brewer(type = "qual" , palette = "Dark2" , direction = 1 ) +
  guides( color = FALSE , fill = FALSE , alpha = FALSE ) +
  # theme_dark() +
  theme( panel.background = element_blank() ,
         panel.grid.major.x = element_blank() ,
         # panel.grid.minor.x = element_blank() , 
         # panel.grid.minor.x = element_line( linetype = 3 , color = "lightgrey" , size = .2 ) ,
         panel.grid.major.y = element_line( linetype = 3 , color = "grey" , size = .2 ) ,
         panel.grid.minor.y = element_line( linetype = 3 , color = "grey" , size = .1 ) ,
         axis.text.x = element_text( angle = 90 , hjust = 1 , vjust = .5 ) ,
         plot.title = element_text(lineheight=.8, face="bold") )
```

A distribuição espacial mostra como as taxas de pobreza mais altas tendem a se concentrar nos estados do nordeste e norte do Brasil.

```{r fgt0_abrinq_uf_mapa, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE, cache=TRUE }
fgt0_stack <- do.call( rbind , res1 )

fgt0_stack <- cbind( year = 2017 , fgt0_stack )
fgt0_stack <- fgt0_stack %>% filter( set %in% c( "uf_name" ) )
fgt0_stack$year <- factor( fgt0_stack$year )

# load maps
# mapsdir <- "/Volumes/Trabalho/Mapas2/municipio_2016/Brasil/BR"

# load libraries
library(ggplot2)
library(maptools)
library(rgeos)
library(rgdal)
library(ggthemes)
# library(ggiraph)

# list and select maps
mapfile <- "~/Bases/Mapas/2016/BR/BRUFE250GC_SIR.shp"

# read map
brmap <- readOGR( dsn = mapfile , verbose = FALSE , stringsAsFactors = FALSE , encoding = "utf8" )

# fix names
colnames( brmap@data ) <- tolower( colnames( brmap@data ) )
# brmap$nm_estado <- stringi::stri_trans_totitle( brmap$nm_estado )
brmap$nm_estado <- tolower( brmap$nm_estado )

# apply standardized projection
brmap <- spTransform( brmap , CRS("+proj=longlat +datum=WGS84") )

# fortify data
final.data <- fortify ( brmap , region = "cd_geocuf" )

# merge two datasets and create final plot data
fgt0_stack$area <- as.character( fgt0_stack$area )
fgt0_stack$nm_estado <- tolower( fgt0_stack$area )
fgt0_stack <- merge( fgt0_stack , brmap@data , by = "nm_estado" , all.x = TRUE , all.y = FALSE )
final.data <- merge( final.data , fgt0_stack , by.x = "id" , by.y = "cd_geocuf" , all.x = TRUE , all.y = FALSE )
final.data <- final.data[ order( final.data$order ) , ]

# force subset
# final.data <- subset( final.data , nm_regiao %in% c( "NORTE" , "NORDESTE" ) )
# final.data <- subset( final.data , nm_regiao %in% c( "NORTE" ) )

# plot map
ggplot ( final.data , aes( x = long, y = lat, group = group , fill = def_vd5002 , color = def_vd5002 ) ) +
  geom_polygon( size = .10 ) + 
  coord_map() +
  # scale_fill_continuous( low = "blue" , high = "red" , limits = c( 0 , 1 ) , labels = scales::percent ) +
  # scale_fill_gradient( low = rgb(105,137,93,maxColorValue = 255) , high = rgb(128,18,24,maxColorValue = 255) , limits = c( 0 , .7 ) , labels = scales::percent , guide = "legend" ) +
  scale_fill_gradient2( low = rgb(105,137,93,maxColorValue = 255) , mid = rgb(254,236,171,maxColorValue = 255) , high = rgb(128,18,24,maxColorValue = 255) , limits = c( 0 , .7 ) , labels = scales::percent , guide = "legend" , midpoint = .3 ) +
  scale_color_gradient2( low = rgb(105,137,93,maxColorValue = 255) , mid = rgb(254,236,171,maxColorValue = 255) , high = rgb(128,18,24,maxColorValue = 255) , limits = c( 0 , .7 ) , labels = scales::percent , guide = "legend" , midpoint = .3 ) +
  # scale_fill_gradient_tableau( labels = scales::percent , guide = "legend" ) +
  labs( title = "Mapa da pobreza entre crianças e adolescentes até 14 anos" , 
        subtitle ="UFs, 2017.\nLinha de Pobreza: R$ 468.50 de Julho/2017." ,
        caption = "Fonte: PNAD Contínua 2017. Microdados.") +
  guides( fill = guide_legend( title = "Taxa de Pobreza" ) , color = FALSE ) +
  theme_dark() +
  theme( panel.background = element_rect( fill = "white" ) , 
         axis.text=element_blank(), 
         axis.ticks=element_blank() , 
         axis.title = element_blank() ,
         panel.grid = element_blank() ,
         plot.title = element_text(lineheight=.8, face="bold") )


```
