---
title: "Mapeando crianças sem registro civil"
author: ~
date: '2017-11-21'
slug: birth-registration-map
categories: [ "R" , "Official Statistics" ]
tags: [ "Mapping" , "Brazil" , "Cities" , "Human Rights" ]
# dev: "pdf"
draft: false
---

Esse post é um pequeno follow-up da discussão sobre mapas de densidade de pontos, mas com um pouco mais de diretos da infância e adolescência. Vamos analisar como se distribuem espacialmente as crianças com e sem registro de nascimento, usando dados dos agregados de setores censitários do Censo 2010. 

Dessa vez, vamos focar em 4 capitais: [Belém](#BEL), [Manaus](#MAO) , [Fortaleza](#FOR) e [São Luís](#SLS).
```{r post_setup, message=FALSE, warning=FALSE, include=FALSE}
# load libraries
library(ggplot2)
library(maptools)
library(rgeos)
library(rgdal)
library(ggthemes)
library(data.table)
library(fst)
library(parallel)


# plot parameters
civil.regist <- c( "Com Registro" , "Sem Registro" , "Não sabe" )
pal <- c("#43a2ca", "#f03b20", "#c994c7" )
stopifnot( length(civil.regist) == length( pal ) ) 



# set folders
mapsdir <- "~/Bases/Mapas/Setores Censitários/2010"
datadir <- "~/Bases/ASC/Censo 2010"

# read datafile
datafile <- list.files( datadir , full.names = TRUE , pattern = "fst" )
datafile <- datafile[ grepl( "^pessoa10" , basename( datafile ) , ignore.case = TRUE ) ]
select_cols <- c( "cod_setor" , paste0( "v00" , 1:3 ) )
dt <- read.fst( datafile , columns = select_cols , as.data.table = TRUE )

# recodes
num_cols <- grep( "^v" , colnames( dt ) , value = TRUE )
dt[ , (num_cols) := lapply( .SD , as.numeric ) , .SDcols = num_cols ]
colnames( dt )[ colnames( dt ) %in% paste0( "v00" , 1:3 ) ] <- civil.regist

# list maps
these_mapfiles <- list.files( mapsdir , full.names = TRUE , recursive = TRUE , pattern = "shp" ) # list shapefiles in `mapsdir`
these_mapfiles <- these_mapfiles[ grepl( "SEE" , basename( these_mapfiles ) , ignore.case = TRUE ) ] # keep census tracts maps

```

Sem mais conversa, prossigamos.

## Belém {#BEL}

```{r mapa1, echo=FALSE, fig.height=20, fig.width=15, message=FALSE, warning=FALSE, cache=TRUE}
# select maps
mapfile <- these_mapfiles[ grepl( "^15" , basename( these_mapfiles ) , ignore.case = TRUE ) ] # keep SP only

# read map
rgmap <- readOGR( dsn = mapfile , verbose = FALSE , stringsAsFactors = FALSE , encoding = "latin1" )

# fix column names
colnames( rgmap@data ) <- tolower( colnames( rgmap@data ) )

# keep Belém only
rgmap <- subset( rgmap , cd_geocodm == '1501402' )

# keep urban areas only
rgmap <- subset( rgmap , tipo == 'URBANO' )

# apply standardized projection
rgmap <- spTransform( rgmap , CRS("+proj=longlat +datum=WGS84") )

# create neighborhood maps
munbmap <- unionSpatialPolygons( rgmap , IDs = rgmap$cd_geocodm )
blocmap <- unionSpatialPolygons( rgmap , IDs = rgmap$cd_geocodi )

# subset data
# keep only census tracts in map
rgdata <- dt[ cod_setor %in% rgmap$cd_geocodi ,]

# merge map with data
mapdata <- merge( rgmap , rgdata , by.x = "cd_geocodi" , by.y = "cod_setor" , all.x = TRUE , all.y = FALSE )

# parallelized code to assign dots to polygons
rep.weight <- 10 # use this to calibrate representativeness in plot

sp.dfs <- 
  mclapply( 
    names( mapdata@data[ , civil.regist ] ) , 
    function( x ) { 
      mapdata@data[ is.na( mapdata@data[, x ] ) , x ] <- 0 ; 
      if( sum( as.integer( mapdata@data[ , x ] / rep.weight ) ) == 0 ) {return(NULL)} ; 
      dotsInPolys( mapdata , as.integer( mapdata@data[ , x ] / rep.weight ), f="random" ) } , 
    mc.set.seed = TRUE, mc.silent = FALSE , mc.cleanup = TRUE )

# store coordinates for as data.frames
dfs <- lapply(sp.dfs, function(x) { if( is.null(x) ) return(NULL) else data.frame(coordinates(x)[,1:2]) })

# categorize dots
for (i in 1:length(civil.regist)) { dfs[[i]]$BirthRegistration <- civil.regist[i] }

# bind rows and define plot order
dots.final <- do.call( rbind , dfs )
dots.final$BirthRegistration <- factor( dots.final$BirthRegistration , levels = civil.regist )

# plot map!
belplot <- ggplot(mapdata) +
  geom_point(data = dots.final, aes(x, y, colour = BirthRegistration , alpha = BirthRegistration , size = BirthRegistration ) ) +
  scale_colour_manual(values = pal) +
  scale_alpha_manual(values = c( .125 , .6 , .6 ) ) +
  scale_size_manual(values = 2*c( .125 , .375 , .375 ) ) +
  geom_path(data = blocmap , aes(long, lat, group = group), colour = "#d3d3d3" , size = .6 , alpha = .1 ) +
  geom_path(data = munbmap , aes(long, lat, group = group), colour = "#d3d3d3" , size = .6 , alpha = .5 ) +
  guides( color = guide_legend( title = "Registro Civil" , override.aes = list( size = 1 , alpha = 1 ) ) , alpha = FALSE , size = FALSE ) +
  theme_map() +
  labs( 
    title = "Registro civil de crianças até 10 anos em Belém (área urbana)" ,
    subtitle = paste0("Cada ponto representa aproximadamente " , rep.weight , " crianças." ) ,
    caption = "Fonte: IBGE. Agregados de Setores Censitários 2010." ) +
  theme( plot.background = element_rect(fill = "black") ,
         plot.title = element_text( color = "white" , size = 20 , family = "Times" ) ,
         plot.subtitle = element_text( color = "white" , size = 15 , family = "Times" ) ,
         plot.caption = element_text( color = "white" , size = 10 , hjust = 1 , family = "Times" ) ,
         legend.position = "right" , 
         legend.background = element_rect( fill = "transparent" , colour = "transparent" ) ,
         legend.key = element_rect( fill = "transparent" , color = "transparent" ) ,
         legend.title = element_text( color = "white" , size = 15 , face = "bold" , family = "Times" ) ,
         legend.text = element_text( color = "white" , size = 13 , family = "Times" ) ) +
  coord_map()

belplot
```

## Manaus {#MAO}

```{r mapa2, echo=FALSE, fig.height=12, fig.width=10, message=FALSE, warning=FALSE, cache=TRUE}
# select maps
mapfile <- these_mapfiles[ grepl( "^13" , basename( these_mapfiles ) , ignore.case = TRUE ) ] # keep SP only

# read map
rgmap <- readOGR( dsn = mapfile , verbose = FALSE , stringsAsFactors = FALSE , encoding = "latin1" )

# fix column names
colnames( rgmap@data ) <- tolower( colnames( rgmap@data ) )

# keep Manaus only
rgmap <- subset( rgmap , cd_geocodm == '1302603' )

# keep urban areas only
rgmap <- subset( rgmap , tipo == 'URBANO' )

# apply standardized projection
rgmap <- spTransform( rgmap , CRS("+proj=longlat +datum=WGS84") )

# create neighborhood maps
munbmap <- unionSpatialPolygons( rgmap , IDs = rgmap$cd_geocodm )
blocmapA <- unionSpatialPolygons( rgmap , IDs = rgmap$cd_geocodi )
blocmapB <- unionSpatialPolygons( rgmap , IDs = rgmap$cd_geocodb )

# subset data
# keep only census tracts in map
rgdata <- dt[ cod_setor %in% rgmap$cd_geocodi ,]

# merge map with data
mapdata <- merge( rgmap , rgdata , by.x = "cd_geocodi" , by.y = "cod_setor" , all.x = TRUE , all.y = FALSE )


# parallelized code to assign dots to polygons
rep.weight <- 10 # use this to calibrate representativeness in plot

sp.dfs <- 
  mclapply( 
    names( mapdata@data[ , civil.regist ] ) , 
    function( x ) { 
      mapdata@data[ is.na( mapdata@data[, x ] ) , x ] <- 0 ; 
      if( sum( as.integer( mapdata@data[ , x ] / rep.weight ) ) == 0 ) {return(NULL)} ; 
      dotsInPolys( mapdata , as.integer( mapdata@data[ , x ] / rep.weight ), f="random" ) } , 
    mc.set.seed = TRUE, mc.silent = FALSE , mc.cleanup = TRUE )

# store coordinates for as data.frames
dfs <- lapply(sp.dfs, function(x) { if( is.null(x) ) return(NULL) else data.frame(coordinates(x)[,1:2]) })

# categorize dots
for (i in 1:length(civil.regist)) { dfs[[i]]$BirthRegistration <- civil.regist[i] }

# bind rows and define plot order
dots.final <- do.call( rbind , dfs )
dots.final$BirthRegistration <- factor( dots.final$BirthRegistration , levels = civil.regist )

# plot map!
maoplot <- ggplot(mapdata) +
  geom_point(data = dots.final, aes(x, y, colour = BirthRegistration , alpha = BirthRegistration , size = BirthRegistration ) ) +
  scale_colour_manual(values = pal) +
  scale_alpha_manual(values = c( .125 , .6 , .6 ) ) +
  scale_size_manual(values = 2*c( .125 , .375 , .375 ) ) +
  geom_path(data = blocmapA , aes(long, lat, group = group), colour = "#d3d3d3" , size = .6 , alpha = .075 ) +
  geom_path(data = blocmapB , aes(long, lat, group = group), colour = "#d3d3d3" , size = .6 , alpha = .15 ) +
  geom_path(data = munbmap , aes(long, lat, group = group), colour = "#d3d3d3" , size = .6 , alpha = .5 ) +
  guides( color = guide_legend( title = "Registro Civil" , override.aes = list( size = 1 , alpha = 1 ) ) , alpha = FALSE , size= FALSE ) +
  theme_map() +
  labs( 
    title = "Registro civil de crianças até 10 anos em Manaus (área urbana)" ,
    subtitle = paste0("Cada ponto representa aproximadamente " , rep.weight , " crianças." ) ,
    caption = "Fonte: IBGE. Agregados de Setores Censitários 2010." ) +
  theme( plot.background = element_rect(fill = "black") ,
         plot.title = element_text( color = "white" , size = 20 , family = "Times" ) ,
         plot.subtitle = element_text( color = "white" , size = 15 , family = "Times" ) ,
         plot.caption = element_text( color = "white" , size = 10 , hjust = 1 , family = "Times" ) ,
         legend.position = "right" , 
         legend.background = element_rect( fill = "transparent" , colour = "transparent" ) ,
         legend.key = element_rect( fill = "transparent" , color = "transparent" ) ,
         legend.title = element_text( color = "white" , size = 15 , face = "bold" , family = "Times" ) ,
         legend.text = element_text( color = "white" , size = 13 , family = "Times" ) ) +
  coord_map()

maoplot

```

## Fortaleza {#FOR}

```{r mapa4, echo=FALSE, fig.height=12, fig.width=10, message=FALSE, warning=FALSE, cache=TRUE}
# select maps
mapfile <- these_mapfiles[ grepl( "^23" , basename( these_mapfiles ) , ignore.case = TRUE ) ] # keep SP only

# read map
rgmap <- readOGR( dsn = mapfile , verbose = FALSE , stringsAsFactors = FALSE , encoding = "latin1" )

# fix column names
colnames( rgmap@data ) <- tolower( colnames( rgmap@data ) )

# keep Fortaleza only
rgmap <- subset( rgmap , cd_geocodm == '2304400' )

# # keep urban areas only
# rgmap <- subset( rgmap , tipo == 'URBANO' )

# apply standardized projection
rgmap <- spTransform( rgmap , CRS("+proj=longlat +datum=WGS84") )

# create neighborhood maps
munbmap <- unionSpatialPolygons( rgmap , IDs = rgmap$cd_geocodm )
blocmapA <- unionSpatialPolygons( rgmap , IDs = rgmap$cd_geocodi )
blocmapB <- unionSpatialPolygons( rgmap , IDs = rgmap$cd_geocodb )

# subset data
# keep only census tracts in map
rgdata <- dt[ cod_setor %in% rgmap$cd_geocodi ,]

# merge map with data
mapdata <- merge( rgmap , rgdata , by.x = "cd_geocodi" , by.y = "cod_setor" , all.x = TRUE , all.y = FALSE )


# parallelized code to assign dots to polygons
rep.weight <- 5 # use this to calibrate representativeness in plot

sp.dfs <- 
  mclapply( 
    names( mapdata@data[ , civil.regist ] ) , 
    function( x ) { 
      mapdata@data[ is.na( mapdata@data[, x ] ) , x ] <- 0 ; 
      if( sum( as.integer( mapdata@data[ , x ] / rep.weight ) ) == 0 ) {return(NULL)} ; 
      dotsInPolys( mapdata , as.integer( mapdata@data[ , x ] / rep.weight ), f="random" ) } , 
    mc.set.seed = TRUE, mc.silent = FALSE , mc.cleanup = TRUE )

# store coordinates for as data.frames
dfs <- lapply(sp.dfs, function(x) { if( is.null(x) ) return(NULL) else data.frame(coordinates(x)[,1:2]) })

# categorize dots
for (i in 1:length(civil.regist)) { dfs[[i]]$BirthRegistration <- civil.regist[i] }

# bind rows and define plot order
dots.final <- do.call( rbind , dfs )
dots.final$BirthRegistration <- factor( dots.final$BirthRegistration , levels = civil.regist )

# plot map!
fortplot <- ggplot(mapdata) +
  geom_point(data = dots.final, aes(x, y, colour = BirthRegistration , alpha = BirthRegistration , size = BirthRegistration ) ) +
  scale_colour_manual(values = pal) +
  scale_alpha_manual(values = c( .125 , .6 , .6 ) ) +
  scale_size_manual(values = 2*c( .125 , .375 , .375 ) ) +
  geom_path(data = blocmapA , aes(long, lat, group = group), colour = "#d3d3d3" , size = .6 , alpha = .075 ) +
  geom_path(data = blocmapB , aes(long, lat, group = group), colour = "#d3d3d3" , size = .6 , alpha = .15 ) +
  geom_path(data = munbmap , aes(long, lat, group = group), colour = "#d3d3d3" , size = .6 , alpha = .5 ) +
  guides( color = guide_legend( title = "Registro Civil" , override.aes = list( size = 1 , alpha = 1 ) ) , alpha = FALSE , size= FALSE ) +
  theme_map() +
  labs( 
    title = "Registro civil de crianças até 10 anos em Fortaleza" ,
    subtitle = paste0("Cada ponto representa aproximadamente " , rep.weight , " crianças." ) ,
    caption = "Fonte: IBGE. Agregados de Setores Censitários 2010." ) +
  theme( plot.background = element_rect(fill = "black") ,
         plot.title = element_text( color = "white" , size = 20 , family = "Times" ) ,
         plot.subtitle = element_text( color = "white" , size = 15 , family = "Times" ) ,
         plot.caption = element_text( color = "white" , size = 10 , hjust = 1 , family = "Times" ) ,
         legend.position = "right" , 
         legend.background = element_rect( fill = "transparent" , colour = "transparent" ) ,
         legend.key = element_rect( fill = "transparent" , color = "transparent" ) ,
         legend.title = element_text( color = "white" , size = 15 , face = "bold" , family = "Times" ) ,
         legend.text = element_text( color = "white" , size = 13 , family = "Times" ) ) +
  coord_map()

fortplot

```

## São Luís {#SLS}

```{r mapa3, echo=FALSE, fig.height=12, fig.width=10, message=FALSE, warning=FALSE, cache=TRUE}
# select maps
mapfile <- these_mapfiles[ grepl( "^21" , basename( these_mapfiles ) , ignore.case = TRUE ) ] # keep SP only

# read map
rgmap <- readOGR( dsn = mapfile , verbose = FALSE , stringsAsFactors = FALSE , encoding = "latin1" )

# fix column names
colnames( rgmap@data ) <- tolower( colnames( rgmap@data ) )

# keep São Luís only
rgmap <- subset( rgmap , cd_geocodm == '2111300' )

# # keep urban areas only
# rgmap <- subset( rgmap , tipo == 'URBANO' )

# apply standardized projection
rgmap <- spTransform( rgmap , CRS("+proj=longlat +datum=WGS84") )

# create neighborhood maps
munbmap <- unionSpatialPolygons( rgmap , IDs = rgmap$cd_geocodm )
blocmapA <- unionSpatialPolygons( rgmap , IDs = rgmap$cd_geocodi )
blocmapB <- unionSpatialPolygons( rgmap , IDs = rgmap$cd_geocodd )

# subset data
# keep only census tracts in map
rgdata <- dt[ cod_setor %in% rgmap$cd_geocodi ,]

# merge map with data
mapdata <- merge( rgmap , rgdata , by.x = "cd_geocodi" , by.y = "cod_setor" , all.x = TRUE , all.y = FALSE )


# parallelized code to assign dots to polygons
rep.weight <- 5 # use this to calibrate representativeness in plot

sp.dfs <- 
  mclapply( 
    names( mapdata@data[ , civil.regist ] ) , 
    function( x ) { 
      mapdata@data[ is.na( mapdata@data[, x ] ) , x ] <- 0 ; 
      if( sum( as.integer( mapdata@data[ , x ] / rep.weight ) ) == 0 ) {return(NULL)} ; 
      dotsInPolys( mapdata , as.integer( mapdata@data[ , x ] / rep.weight ), f="random" ) } , 
    mc.set.seed = TRUE, mc.silent = FALSE , mc.cleanup = TRUE )

# store coordinates for as data.frames
dfs <- lapply(sp.dfs, function(x) { if( is.null(x) ) return(NULL) else data.frame(coordinates(x)[,1:2]) })

# categorize dots
for (i in 1:length(civil.regist)) { dfs[[i]]$BirthRegistration <- civil.regist[i] }

# bind rows and define plot order
dots.final <- do.call( rbind , dfs )
dots.final$BirthRegistration <- factor( dots.final$BirthRegistration , levels = civil.regist )

# plot map!
slsplot <- ggplot(mapdata) +
  geom_point(data = dots.final, aes(x, y, colour = BirthRegistration , alpha = BirthRegistration , size = BirthRegistration ) ) +
  scale_colour_manual(values = pal) +
  scale_alpha_manual(values = c( .125 , .6 , .6 ) ) +
  scale_size_manual(values = 2*c( .125 , .375 , .375 ) ) +
  geom_path(data = blocmapA , aes(long, lat, group = group), colour = "#d3d3d3" , size = .6 , alpha = .075 ) +
  geom_path(data = blocmapB , aes(long, lat, group = group), colour = "#d3d3d3" , size = .6 , alpha = .15 ) +
  geom_path(data = munbmap , aes(long, lat, group = group), colour = "#d3d3d3" , size = .6 , alpha = .5 ) +
  guides( color = guide_legend( title = "Registro Civil" , override.aes = list( size = 1 , alpha = 1 ) ) , alpha = FALSE , size= FALSE ) +
  theme_map() +
  labs( 
    title = "Registro civil de crianças até 10 anos em São Luís" ,
    subtitle = paste0("Cada ponto representa aproximadamente " , rep.weight , " crianças." ) ,
    caption = "Fonte: IBGE. Agregados de Setores Censitários 2010." ) +
  theme( plot.background = element_rect(fill = "black") ,
         plot.title = element_text( color = "white" , size = 20 , family = "Times" ) ,
         plot.subtitle = element_text( color = "white" , size = 15 , family = "Times" ) ,
         plot.caption = element_text( color = "white" , size = 10 , hjust = 1 , family = "Times" ) ,
         legend.position = "right" , 
         legend.background = element_rect( fill = "transparent" , colour = "transparent" ) ,
         legend.key = element_rect( fill = "transparent" , color = "transparent" ) ,
         legend.title = element_text( color = "white" , size = 15 , face = "bold" , family = "Times" ) ,
         legend.text = element_text( color = "white" , size = 13 , family = "Times" ) ) +
  coord_map()

slsplot

```

